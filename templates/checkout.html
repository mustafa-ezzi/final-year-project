{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout | FashionHub</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
            playfair: ['Playfair Display', 'serif'],
          },
          colors: {
            luxury: '#1e293b',
            gold: '#d4af37',
          }
        }
      }
    }
  </script>
</head>

<body class="font-inter bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen">

<!-- Navbar -->
<nav class="fixed top-0 w-full bg-white/80 backdrop-blur-lg shadow-lg z-50">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <a href="#" class="font-playfair text-2xl font-extrabold text-slate-800 flex items-center gap-2">
      <i class="fas fa-gem text-indigo-600"></i> FashionHub
    </a>
    <a href="{% url 'index' %}" class="text-indigo-600 font-semibold hover:underline flex items-center gap-2">
      <i class="fas fa-arrow-left"></i> Continue Shopping
    </a>
  </div>
</nav>

<!-- Page Wrapper -->
<div class="pt-28 pb-16 max-w-7xl mx-auto px-6">

  <!-- Header -->
  <div class="text-center mb-12">
    <h1 class="font-playfair text-4xl font-extrabold text-slate-800">Checkout</h1>
    <p class="text-slate-500 mt-2">Complete your purchase with confidence</p>
  </div>

  <!-- Steps -->
  <div class="flex justify-center gap-4 mb-12 flex-wrap">
    <div class="px-6 py-3 rounded-full bg-indigo-600 text-white font-semibold shadow-lg">1 • Shipping</div>
    <div class="px-6 py-3 rounded-full bg-white shadow text-slate-700 font-semibold">2 • Payment</div>
    <div class="px-6 py-3 rounded-full bg-white shadow text-slate-700 font-semibold">3 • Review</div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- LEFT: Shipping & Payment -->
    <div class="lg:col-span-2 space-y-8">

      <!-- Shipping -->
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <h2 class="font-playfair text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
          <i class="fas fa-shipping-fast text-indigo-600"></i> Shipping Information
        </h2>

        <form id="checkout-form">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <input class="lux-input" name="first_name" placeholder="First Name" required>
            <input class="lux-input" name="last_name" placeholder="Last Name" required>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mt-5">
            <input class="lux-input" name="email" placeholder="Email Address" value="{{ request.session.customer_email }}" required>
            <input class="lux-input" name="phone_number" placeholder="Phone Number" value="{{ request.session.customer_phone }}" required>
          </div>

          <input class="lux-input mt-5" name="address" placeholder="Street Address" required>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mt-5">
            <input class="lux-input" name="city" placeholder="City" required>
            <input class="lux-input" name="state" placeholder="State" required>
            <input class="lux-input" name="zip" placeholder="ZIP Code" required>
          </div>

          <!-- Shipping Options -->
          <div class="mt-8 space-y-4">
            <div class="shipping-card active" data-price="0">
              <div>
                <p class="font-semibold">Standard Shipping</p>
                <p class="text-sm text-slate-500">5–7 business days</p>
              </div>
              <span class="font-bold text-indigo-600">$0</span>
            </div>

            <div class="shipping-card" data-price="15">
              <div>
                <p class="font-semibold">Express Shipping</p>
                <p class="text-sm text-slate-500">2–3 business days</p>
              </div>
              <span class="font-bold text-indigo-600">$15</span>
            </div>
          </div>
        </form>
      </div>

      <!-- Payment (static for now) -->
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <h2 class="font-playfair text-2xl font-bold mb-6 flex items-center gap-3">
          <i class="fas fa-credit-card text-indigo-600"></i> Payment Information
        </h2>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="pay-card active"><i class="fas fa-credit-card"></i> Card</div>
          <div class="pay-card"><i class="fab fa-paypal"></i> PayPal</div>
          <div class="pay-card"><i class="fab fa-apple-pay"></i> Apple</div>
          <div class="pay-card"><i class="fab fa-google-pay"></i> Google</div>
        </div>

        <input class="lux-input" name="card_number" placeholder="Card Number">
        <div class="grid grid-cols-2 gap-5 mt-5">
          <input class="lux-input" name="expiry" placeholder="MM/YY">
          <input class="lux-input" name="cvv" placeholder="CVV">
        </div>
        <input class="lux-input mt-5" name="cardholder_name" placeholder="Cardholder Name">
      </div>
    </div>

    <!-- RIGHT: Order Summary -->
    <div class="sticky top-32 h-fit">
      <div class="bg-white rounded-2xl shadow-2xl p-8">
        <h3 class="font-playfair text-2xl font-bold mb-6 border-b pb-4">Order Summary</h3>

        {% for item in cart.items.all %}
        <div class="flex gap-4 mb-6">
          <img src="{{ item.product.image.url }}" class="rounded-xl shadow w-24 h-24 object-cover">
          <div class="flex-1">
            <p class="font-semibold">{{ item.product.name }}</p>
            <p class="text-sm text-slate-500">{{ item.product.description|truncatewords:5 }}</p>
            <p class="font-bold text-indigo-600 mt-2">${{ item.subtotal }}</p>
          </div>
        </div>
        {% empty %}
        <p class="text-gray-500 text-center">Your cart is empty.</p>
        {% endfor %}

        <!-- Prices -->
        <div class="space-y-3 text-sm">
          <div class="flex justify-between"><span>Subtotal</span><span>${{ cart.total_price }}</span></div>
          <div class="flex justify-between"><span>Shipping</span><span id="shipping-price">$0</span></div>
          <div class="flex justify-between"><span>Tax (10%)</span><span id="tax-amount">${{ cart.total_price|floatformat:2|add:"0.0"|floatformat:"0" }}</span></div>
        </div>

        <div class="flex justify-between text-lg font-bold mt-6 border-t pt-4">
          <span>Total</span>
          <span id="total-price" class="text-indigo-600">${{ cart.total_price }}</span>
        </div>

        <button id="place-order" class="w-full mt-8 py-4 rounded-xl bg-gradient-to-r from-indigo-600 to-indigo-800 text-white font-bold text-lg shadow-xl hover:scale-[1.02] transition">
          <i class="fas fa-lock mr-2"></i> Complete Order
        </button>

        <p class="text-xs text-center text-slate-500 mt-4">
          <i class="fas fa-shield-alt text-green-500"></i> Secure • SSL Encrypted
        </p>
      </div>
    </div>

  </div>
</div>

<script>
  // Handle shipping selection & calculate total
  const shippingCards = document.querySelectorAll(".shipping-card");
  let shippingPrice = 0;
  shippingCards.forEach(card => {
    card.addEventListener("click", () => {
      shippingCards.forEach(c => c.classList.remove("active"));
      card.classList.add("active");
      shippingPrice = parseFloat(card.dataset.price);
      document.getElementById("shipping-price").innerText = "$" + shippingPrice.toFixed(2);
      updateTotal();
    });
  });

  function updateTotal(){
    let subtotal = {{ cart.total_price }};
    let tax = subtotal * 0.1; // 10% tax
    let total = subtotal + tax + shippingPrice;
    document.getElementById("total-price").innerText = "$" + total.toFixed(2);
    document.getElementById("tax-amount").innerText = "$" + tax.toFixed(2);
  }

  // Handle order submission
  document.getElementById("place-order").addEventListener("click", async () => {
    const form = document.getElementById("checkout-form");
    const formData = {
      first_name: form.first_name.value,
      last_name: form.last_name.value,
      email: form.email.value,
      phone_number: form.phone_number.value,
      address: form.address.value,
      city: form.city.value,
      state: form.state.value,
      zip: form.zip.value,
      shipping: shippingPrice
    };

    const response = await fetch("{% url 'checkout' %}", {
      method: "POST",
      headers: {"Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}"},
      body: JSON.stringify(formData)
    });

    const result = await response.json();
    if(result.success){
      alert(result.message);
      window.location.href = "{% url 'index' %}";
    } else {
      alert("Something went wrong!");
    }
  });
</script>

<style>
  .lux-input {
    @apply w-full px-4 py-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500;
  }
  .shipping-card {
    @apply flex justify-between items-center border rounded-xl p-4 cursor-pointer hover:border-indigo-500;
  }
  .shipping-card.active {
    @apply border-indigo-600 bg-indigo-50;
  }
  .pay-card {
    @apply border rounded-xl py-3 flex flex-col items-center justify-center gap-1 cursor-pointer hover:border-indigo-500;
  }
  .pay-card.active {
    @apply border-indigo-600 bg-indigo-50 text-indigo-600;
  }
</style>

</body>
</html>
